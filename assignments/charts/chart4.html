<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet"> <!-- Fira Sans & Roboto Slab fonts -->
    <link rel="stylesheet" href="../../css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"  rel="stylesheet"  type='text/css'>
    
    
    <script src="https://d3js.org/d3.v4.js"></script>  <!-- Load d3.js -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.5/dist/js/bootstrap.min.js"></script>
    <script src="../../js/main.js"></script>
    
  </head>

  <body>

  <!-- ################################# NAVBAR #################################### -->
  <nav class="navbar navbar-default background-color navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed colored_text" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../../index.html">
                <img alt="Logo" src="../../img/logo.svg" class="img-logo">
            </a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div><!-- /.navbar-collapse -->
    </div>
</nav>

<div class="container center">
    <section class="margin-title-section">
      <h1 class="title">Stacked Percentage Chart</h1>
      <hr>
    </section>
    <hr>

    <div id="stacked-percentage">
      <script>
        // set the dimensions and margins of the graph
        var margin = {top: 10, right: 30, bottom: 20, left: 180},
                      width = 760 - margin.left - margin.right,
                      height = 400 - margin.top - margin.bottom;
      
        // append the svg object to the body of the page
        var svg = d3.select("#stacked-percentage")
                  .append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                      .attr("transform",
                          "translate(" + margin.left + "," + margin.top + ")");
        
        
        d3.csv("../../python/data/circos_per_trees.csv", function(data) {
          console.log(data)
          var columnsName = data.columns.slice(1);
          var circo = d3.map(data, function(d){return(d.circoscrizione)}).keys()
          var treeNames = d3.map(data, function(d){return(d.Name)}).keys()
          //console.log(circo);
          //console.log(treeNames);
          //console.log(columnsName);



          var dict = {};
          var i = 0
  
          circo.forEach(function(c){
            while(i <data.length){
              
              if (data[i].circoscrizione != c){
                i++;
                break;
              }

              if(dict[c]){
                dict[c].push(data[i].count)
              }

              else{
                dict[c] = [data[i].count]
              }

              i++;
            }
          })
          console.log(dict);




          // Add X axis
          var x = d3.scaleLinear()
            .domain([0, 100])
            .range([0, width]);

          svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).tickSizeOuter(0));

          // Add Y axis
          var y = d3.scaleBand()
            .domain(circo)
            .range([ height, 0 ])
            .padding([0.3]);

          svg.append("g")
            .call(d3.axisLeft(y).tickSizeOuter(0));

          // color palette = one color per subgroup
          var color = d3.scaleOrdinal()
            .domain(treeNames)
            .range(['#FCCFF4','#BCB0EE','#A6D5FD', '#B4F1B3', '#F7F3CD', '#F2B6AE'])



          
         // Normalize the data -> sum of each group must be 100!
          for(k in dict){
            tot = 0

            dict[k].forEach(function(v){ tot += Number(v) })

            for(var i = 0; i < dict[k].length; ++i){
              var value = dict[k][i];
              dict[k][i] = Number(value) / tot*100
            }
          }

          console.log(dict)



          ////stack the data? --> stack per tree
          var stackedData = d3.stack()
                          .keys(treeNames)
                          (data)


          // Show the bars
          svg.append("g")
            .selectAll("g")
            // Enter in the stack data = loop key per key = group per group
            .data(stackedData)
            .enter().append("g")
              .attr("fill", function(d) { return color(d.key); })
              .selectAll("rect")
              // enter a second time = loop subgroup per subgroup to add all rectangles
              .data(function(d) { return d; })
              .enter().append("rect")
                .attr("y", function(d) { return y(d.data.circoscrizione); })
                .attr("x", function(d) { return x(d[1]); })
                .attr("height", function(d) { return x(d[0]) - x(d[1]); })
                .attr("width",y.bandwidth())
        })

            
          
          

        
      </script>
    </div>
</div> <!-- chiude container -->


<footer class="text-center text-lg-start">
    <div class="footer-top-space text-center p-3 background-color colored_text">
        Â© 2022 Copyright:
      <a class="text-dark colored_text" href="https://github.com/IncapacheSpark/IncapacheSpark.github.io">IncapacheSpark Github</a>
    </div>
</footer>

    
    
  </body>
</html>