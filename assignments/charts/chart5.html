<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet"> <!-- Fira Sans & Roboto Slab fonts -->
    <link rel="stylesheet" href="../../css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"  rel="stylesheet"  type='text/css'>

    <title>IncapacheSpark</title>
  </head>

  <body>

    <!-- ################################# NAVBAR #################################### -->
    <nav class="navbar navbar-default background-color navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed colored_text" data-toggle="collapse"
                        data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="../../index.html">
                    <img alt="Logo" src="../../img/logo.svg" class="img-logo">
                </a>
            </div>
        </div>
    </nav>
    <nav class="breadcrumb-pos" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="../../index.html">Home</a></li>
            <li class="breadcrumb-item"><a href="../comparison.html">Assignment 1</a></li>
            <li class="breadcrumb-item active" aria-current="page">Stackedchart</li>
        </ol>
    </nav>

<div class="container center">
    <h1 class="title margin-title-section"> Waffle Chart</h1>
      <hr>
   <div id="waffle"></div>
 <div id="legend"></div>
</div> <!-- chiude container -->


<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.5/dist/js/bootstrap.min.js"></script>
<script src="../../js/main.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>

<!-- Load d3.js -->


<script>

var total = 0;
var width,
    height,
    widthSquares = 20,
    heightSquares = 5,
    squareSize = 25,
    squareValue = 0,
    gap = 1,
    theData = [];

var color = d3.scale.category10();

  d3.csv("../../python/data/circoscrizioni_top_trees.csv", function (data) {


  const TreeNames = Object.keys(data[0]).filter(d => d !== "Neighbourhood");
  // List of groups = species here = value of the first column called group -> I show them on the Y axis
  const neighbourhoods = data.map(d => d.Neighbourhood);


  data.forEach(function (d) {
      // Compute the total
      tot = 0
      for (i in TreeNames) {
          name = TreeNames[i];
          tot += +d[name]
      }

      // Now normalize
      // for (i in TreeNames) {
      //     name = TreeNames[i];
      //     d[name] = d[name] / tot * 100
      // }
  })

  console.log(total);
  //value of a square
  squareValue = tot / (widthSquares*heightSquares);

  //remap data
  data.forEach(function(d, i)
  {
      d.population = +d.population;
      d.units = Math.floor(d.population/squareValue);
      theData = theData.concat(
        Array(d.units+1).join(1).split('').map(function()
          {
            return {  squareValue:squareValue,
                      units: d.units,
                      population: d.population,
                      groupIndex: i};
          })
        );
  });

  width = (squareSize*widthSquares) + widthSquares*gap + 25;
  height = (squareSize*heightSquares) + heightSquares*gap + 25;

  var waffle = d3.select("#waffle")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .selectAll("div")
      .data(theData)
      .enter()
      .append("rect")
      .attr("width", squareSize)
      .attr("height", squareSize)
      .attr("fill", function(d)
      {
        return color(d.groupIndex);
      })
      .attr("x", function(d, i)
        {
          //group n squares for column
          col = Math.floor(i/heightSquares);
          return (col*squareSize) + (col*gap);
        })
      .attr("y", function(d, i)
      {
        row = i%heightSquares;
        return (heightSquares*squareSize) - ((row*squareSize) + (row*gap))
      })
      .append("title")
        .text(function (d,i)
          {
            return "Age range: " + data[d.groupIndex].age + " | " +  d.population + " , " + d.units + "%"
          });

   //add legend with categorical data
   var legend = d3.select("#legend")
    .append("svg")
    .attr('width', 300)
    .attr('height', 200)
    .append('g')
    .selectAll("div")
    .data(data)
    .enter()
      .append("g")
      .attr('transform', function(d,i){ return "translate(0," + i*20 + ")";});
  legend.append("rect")
    .attr("width", 18)
    .attr("height", 18)
    .style("fill", function(d, i) { return color(i)});
  legend.append("text")
    .attr("x", 25)
    .attr("y", 13)
    .text( function(d) { return d.age});

    //add value of a unit square
    var legend2 = d3.select("#legend")
      .select('svg')
      .append('g')
      .attr('transform', "translate(100,0)");

legend2.append("text")
        .attr('y', '14')
        .attr('font-size', '18px')
        .text("Total: " + total)
        .attr("fill", "#444444");
});

</script>



<footer class="text-center text-lg-start">
    <div class="footer-top-space text-center p-3 background-color colored_text">
        Â© 2022 Copyright:
      <a class="text-dark colored_text" href="https://github.com/IncapacheSpark/IncapacheSpark.github.io">IncapacheSpark Github</a>
    </div>
  </footer>

  </body>
</html>
